# Production stage - Hardened Alpine with digest pinning
# FROM alpine:3.20@sha256:77726ef6b57ddf65bb551896826ec38bc3e53f75cdde31354fbffb4f25238ebd
FROM alpine:3.20

# Security hardening - Install required packages and remove dangerous utilities
RUN apk upgrade --no-cache && \
    apk add --no-cache \
    ca-certificates \
    libpcap \
    libcap \
    nmap \
    nmap-scripts \
    bind-tools \
    tini \
    gettext && \
    # Remove potentially dangerous utilities
    rm -rf /bin/su \
    /bin/mount \
    /bin/umount \
    /sbin/mount* \
    /usr/bin/passwd \
    /usr/bin/chpasswd \
    /usr/sbin/adduser \
    /usr/sbin/deluser \
    /etc/crontabs \
    /var/spool/cron && \
    # Clean package cache and temporary files
    rm -rf /var/cache/apk/* /tmp/* /var/tmp/* && \
    # Create secure directories with proper permissions
    mkdir -p /app/data /tmp && \
    chmod 1777 /tmp && \
    chmod 755 /app

WORKDIR /app

# Copy pre-built binary with secure permissions
# Note: Binary should be built with: CGO_ENABLED=1 go build -ldflags='-w -s' -o naabum8 .
COPY naabum8 /usr/local/bin/naabum8
# Copy entrypoint script
COPY --chown=appuser:appuser docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

RUN chmod 755 /usr/local/bin/naabum8 && \
    # Set capabilities for non-root network operations (fallback - Docker runtime caps preferred)
    setcap cap_net_raw,cap_net_admin,cap_net_bind_service+eip /usr/local/bin/naabum8

# Use tini as init system for proper signal handling
ENTRYPOINT ["/sbin/tini", "--"]

# Health check with proper command
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /usr/local/bin/naabum8 help || exit 1

# Metadata
LABEL maintainer="i@deifzar.me" \
    version="1.0" \
    description="NaabuM8 - Hardened Network Port Scanner (Runtime)" \
    security.scan="required-root-privileges"

# Use custom entrypoint for secret loading 
ENTRYPOINT ["docker-entrypoint.sh"]

# Default command
CMD ["naabum8", "launch"]